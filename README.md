# Node.js API Boilerplate with Clean Architecture

![Test Coverage](https://img.shields.io/badge/coverage-100%25-brightgreen)
![License](https://img.shields.io/badge/license-MIT-blue)

A robust and opinionated boilerplate for building scalable, testable, and maintainable backend applications in Node.js and TypeScript, following the principles of **Clean Architecture** and **Hexagonal Architecture (Ports and Adapters)**.

## ‚ú® Philosophy

The goal of this boilerplate is to provide a solid foundation that clearly separates concerns, allowing business logic to evolve independently of frameworks and infrastructure details.

> The **business logic** and application rules (`core`) are the center of the universe. They must not depend on anything. The outer layers, such as the **database** (`infra`) and the **HTTP API** (`presentation`), depend on the core, not the other way around.

---

## ‚öôÔ∏è Tech Stack

- **Language**: TypeScript
- **Platform**: Node.js
- **Web Framework**: Fastify
- **ORM**: Drizzle ORM
- **Database**: PostgreSQL (via Docker)
- **Testing**: Vitest (for unit and integration tests)
- **Validation**: Zod
- **Authentication**: JWT (using `jose`)
- **Logging**: Winston
- **Code Quality**: ESLint & Prettier

---

## üöÄ Key Features

- ‚úÖ **Clean/Hexagonal Architecture**: Complete separation between business logic and infrastructure details.
- ‚úÖ **Dependency Injection**: Classes and dependencies are wired up in the `CompositionRoot`, making it easy to swap implementations and test.
- ‚úÖ **Full JWT Authentication**: Ready-to-use flows for `signup`, `signin`, `signout`, `refresh token`, and `signout-all`.
- ‚úÖ **Comprehensive Testing**: Near 100% coverage with unit tests for the `core` and integration tests for the API and database.
- ‚úÖ **Robust Validation**: API contracts and schema validation using Zod.
- ‚úÖ **Automatic Documentation**: OpenAPI (Swagger) specification generation from Zod schemas.
- ‚úÖ **Structured Logging**: Configured logging with Winston for different levels and environments.
- ‚úÖ **Containerized Database**: Standardized development and testing environment with Docker Compose.
- ‚úÖ **Database Migrations**: Schema evolution management with Drizzle Kit.

---

## üèÅ Getting Started

### Prerequisites

- [Node.js](https://nodejs.org/) (version 20 or higher)
- [pnpm](https://pnpm.io/)
- [Docker](https://www.docker.com/) & Docker Compose

### Installation

1.  **Clone the repository:**

    ```bash
    git clone [https://github.com/rafael-desouza/node-clean-architecture](https://github.com/rafael-desouza/node-clean-architecture)
    ```

2.  **Install dependencies:**

    ```bash
    pnpm install
    ```

3.  **Set up environment variables:**
    - Create a copy of the example file for both development and test environments.

    ```bash
    cp .env.example .env.development
    cp .env.example .env.test
    ```

    - Fill in the variables in both files (`.env.development` and `.env.test`) with the correct values. The test database (`TEST_DATABASE_URL`) should point to the Docker container.

4.  **Start the database:**

    ```bash
    docker-compose up -d
    ```

5.  **Run the migrations:**
    - This command will create the tables in the database spun up by Docker.
    ```bash
    pnpm db:migrate
    ```

---

## üìú Available Scripts

| Command                 | Description                                             |
| :---------------------- | :------------------------------------------------------ |
| `pnpm dev`              | Starts the server in development mode with hot-reload.  |
| `pnpm test`             | Runs all tests (unit and integration).                  |
| `pnpm test:unit`        | Runs only the unit tests.                               |
| `pnpm test:integration` | Runs only the integration tests.                        |
| `pnpm test:coverage`    | Runs all tests and generates a coverage report.         |
| `pnpm db:generate`      | Generates a new migration file based on schema changes. |
| `pnpm db:migrate`       | Applies pending migrations to the database.             |
| `pnpm lint`             | Runs ESLint to check and fix code style issues.         |

---

## üìÅ Project Structure

- **`__tests__`**: Contains all tests, separated into `unit` and `integration`.
- **`drizzle`**: Contains the database migration files generated by Drizzle Kit.
- **`src/core`**: The heart of the application. Contains no dependencies on frameworks.
  - `domain`: The pure business entities.
  - `application`: Use cases and the interfaces (ports) to the outside world.
- **`src/infra`**: Concrete implementations of the `core` interfaces. This is where external libraries (Fastify, Drizzle, Winston) are used.
- **`src/presentation`**: The entry layer of the application. Handles HTTP requests, data validation (contracts), and responses.
- **`src/composition-root.ts`**: Where all classes are instantiated and dependencies are injected.

---

## üõ†Ô∏è Adding a New Feature (e.g., Products)

To add a new feature, follow the principles of the architecture:

1.  **Domain**: Create the `Product` entity in `src/core/domain/product.entity.ts`.
2.  **Ports**: Define the `ProductRepository` interface in `src/core/application/repositories/product.repository.ts`.
3.  **Use Case**: Create the `CreateProductUseCase` in `src/core/application/use-cases/product/create-product.use-case.ts`.
4.  **Unit Test**: Write a test for the `CreateProductUseCase` in `__tests__/unit/core/application/use-cases/product/`.
5.  **Infra (Repository)**: Create the `ProductRepositoryDrizzle` implementation in `src/infra/repositories/product/`.
6.  **Presentation (Contract)**: Create the `CreateProductContract` with Zod schemas in `src/presentation/contracts/product/`.
7.  **Presentation (Controller)**: Add the `POST /products` route in a new `ProductController`.
8.  **Dependency Injection**: Wire everything together in the `composition-root.ts`.
9.  **Integration Test**: Write an E2E test in `__tests__/integration/product.e2e.spec.ts` that calls the new route and verifies the response and database state.

---

## üîë Environment Variables

The following variables need to be defined in your `.env.*` files:

| Variable            | Description                                                      | Example                                               |
| :------------------ | :--------------------------------------------------------------- | :---------------------------------------------------- |
| `DATABASE_URL`      | Connection URL for the development database.                     | `"postgresql://user:pass@localhost:5432/dev_db"`      |
| `TEST_DATABASE_URL` | Connection URL for the test database (container).                | `"postgresql://docker:docker@localhost:5433/test_db"` |
| `PORT`              | The port the server will run on.                                 | `3333`                                                |
| `JWT_SECRET`        | The secret used to sign JWTs.                                    | `"your-super-secret-key"`                             |
| `ACCESS_TOKEN_TTL`  | The time-to-live for the access token (e.g., `15m`, `1h`, `1d`). | `15m`                                                 |
| `REFRESH_TOKEN_TTL` | The time-to-live for the refresh token (e.g., `7d`, `30d`).      | `7d`                                                  |

---
